<!DOCTYPE html>
<html>
	<head>
		<meta charset=utf-8 />
		<title>GoSpatial Gatekeeper</title>
		<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
	
		<!-- JQuery -->
		<script src="/jquery/jquery-1.11.0.js" ></script>

		<!-- Bootstrap -->
		<script src="/bootstrap/bootstrap.js"></script>
		<link href="/bootstrap/bootstrap.min.css" rel="stylesheet">
		<link href="/bootstrap/2-col-portfolio.css" rel="stylesheet">

		<!-- Font Awesome CSS -->
		<link rel="stylesheet" href="/font-awesome-4.3.0/css/font-awesome.min.css">

		<!-- Sweet Alert -->
		<script src="/bootstrap-sweetalert/dist/sweetalert.min.js"></script>
		<link rel="stylesheet" type="text/css" href="/bootstrap-sweetalert/dist/sweetalert.css">

		<style>

			/* "Back to Top" button */
			#toTop{
				position: fixed;
				bottom: 20px;
				right: 40px;
				cursor: pointer;
				display: none;
			}

		</style>

		<script>
			// "Back to Top" button
			// http://cotswoldphoto.co.uk/bootstrap-float-to-top-button/
			$(document).ready(function(){
				$('body').append('<div id="toTop" class="btn btn-default"><i class="fa fa-chevron-up" aria-hidden="true"></i></div>');
					$(window).scroll(function () {
						if ($(this).scrollTop() != 0) {
							$('#toTop').fadeIn();
						} else {
							$('#toTop').fadeOut();
						}
					}); 
				$('#toTop').click(function(){
					$("html, body").animate({ scrollTop: 0 }, 600);
					return false;
				});
			});
		</script>

	</head>
	<body>
		<!-- Navigation -->
		<nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
			<div class="container">
				<!-- Brand and toggle get grouped for better mobile display -->
				<div class="navbar-header">
					<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
						<span class="sr-only">Toggle navigation</span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
					</button>
					<a class="navbar-brand" href="../management?apikey={{.Apikey}}">
						 GoSpatial
					</a>
				</div>
				<!-- Collect the nav links, forms, and other content for toggling -->
				<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
					<ul class="nav navbar-nav">
						<li>
							<a href="../management?apikey={{.Apikey}}"><i class="fa fa-users"></i> Management</a>
						</li>
						<li>
							<a href="../map?apikey={{.Apikey}}"><i class="fa fa-compass"></i> Map</a>
						</li> 
						<li>
							<a href="http://sjsafranek.github.io/gospatial/"><i class="fa fa-question-circle"></i> Docs</a>
						</li>
					</ul>
				</div>
				<!-- /.navbar-collapse -->
			</div>
			<!-- /.container -->
		</nav>

		<!-- Page Content -->
		<div class="container">

			<!-- Page Header -->
			<div class="row">
				<div class="col-lg-12">
					<h2 class="page-header">Management <small>Manage layers and basemaps</small></h2>
				</div>
			</div> 
			<!-- /. Page Header -->

			<div class="row">
				<div class="col-xs-12 column">
					<div class="panel panel-default">
						<div class="panel-heading">
							<h3 class="panel-title">Layer Management</h3>
						</div>
						<div class="panel-body">
							<div class="row">
								<div class="col-md-2 column">
									<div class="panel-body">
									<!-- <div class="well"> -->
										<button class="btn btn-primary createLayer">Create Vector Layer</button>
									</div>
								</div>
								<div class="col-md-10 column">
									<div class="panel-body">
										<!-- <div class="well"> -->
											<table class="table table-striped table-bordered">
												<thead>
													<tr>
														<th>#</th>
														<th class="col-md-1">Delete</th>
														<th>Datasource</th>
													</tr>
												</thead>
												<tbody id="layers_list">
												</tbody>
											</table>
										<!-- </div> -->
									</div>
								</div>
							</div>
						</div>

					</div>
				</div>
			</div>

			<div class="row">
				<div class="col-xs-12 column">
					<div class="panel panel-default">
						<div class="panel-heading">
							<h3 class="panel-title">TileLayer Management</h3>
						</div>
						<div class="panel-body">
							<div class="row">
								<div class="col-md-4 column">
									<div class="panel-body">
										<div class="well">
											<label for="name">Name:</label>
											<input type="text" name="tilelayer_name" class="form-control" id="tilelayer_name">
											<label for="name">Url:</label>
											<input type="text" name="tilelayer_url" class="form-control" id="tilelayer_url">
											<br>
											<button class="btn btn-primary createTileLayer">Create TileLayer</button>
										</div>
									</div>
								</div>
								<div class="col-md-8 column">
									<div class="panel-body">
										<!-- <div class="well"> -->
											<table class="table table-striped table-bordered">
												<thead>
													<tr>
														<th>#</th>
														<th>Name</th>
														<th>Url</th>
													</tr>
												</thead>
												<tbody id="tilelayers_list">
												</tbody>
											</table>
										</div>
									</div>
								</div>
							</div>
						</div>

					</div>
				</div>
			</div>


		</div>
		<!-- /. Page Content -->













		<script>

			$(document).ready(function(){
				$("button.deleteLayer").click(function(){
					var datasource_id = $(this).attr("ds_id");
					swal({
						title: "Delete layer",
						text: "Are you sure you want to delete " + datasource_id,
						type: "warning",	 
						showCancelButton: true,	 
						confirmButtonColor: "#DD6B55",	 
						confirmButtonText: "Yes, delete it!",	 
						cancelButtonText: "No, cancel pls!",	 
						closeOnConfirm: false,	 
						closeOnCancel: false,
						showLoaderOnConfirm: true
					},
					function(isConfirm){
						if (isConfirm) {
						$.ajax({
							url: '/api/v1/layer/'+ datasource_id +'?apikey={{.Apikey}}',
							type: 'DELETE',
							success: function(result) {
								swal("Deleted!", result, "success");
								$("#layers_list").html("");
								refreshDatasources();
							},
							failure: function(result) {
								console.log(result);
								throw new Error(result);
							}
						});
						} 
						else {
							swal("Cancelled", "Your data is safe :)", "error");
						}
					});
				});

				$("button.createLayer").click(function(){
					var datasource_id = $(this).attr("ds_id");
					swal({
						title: "Create layer",
						text: "Are you sure you want to create a new lyaer",
						type: "info",
						showCancelButton: true,
						confirmButtonColor: "#DD6B55",
						confirmButtonText: "Yes, pls!",
						cancelButtonText: "No, cancel pls!",
						closeOnConfirm: false,
						closeOnCancel: true,
						showLoaderOnConfirm: true
					},
					function(isConfirm){
						if (isConfirm) {
						$.ajax({
							url: '/api/v1/layer?apikey={{.Apikey}}',
							type: 'POST',
							success: function(result) {
								swal("Created!", result, "success");
								$("#layers_list").html("");
								refreshDatasources();
							},
							failure: function(result) {
								console.log(result);
								throw new Error(result);
							}
						});
						} 
					});
				});

				$("button.createTileLayer").click(function(){
					var datasource_id = $(this).attr("ds_id");
					swal({
						title: "Create tile layer",
						text: "Are you sure you want to create a new tile lyaer",
						type: "info",
						showCancelButton: true,
						confirmButtonColor: "#DD6B55",
						confirmButtonText: "Yes, pls!",
						cancelButtonText: "No, cancel pls!",
						closeOnConfirm: false,
						closeOnCancel: true,
						showLoaderOnConfirm: true
					},
					function(isConfirm){
						if (isConfirm) {
						$.ajax({
							url: '/api/v1/tilelayer?apikey={{.Apikey}}',
							data: {
								tilelayer_name: $("#tilelayer_name").val(),
								tilelayer_url: $("#tilelayer_url").val()
							},
							type: 'POST',
							success: function(result) {
								swal("Created!", result, "success");
								$("#tilelayers_list").html("");
								refreshTileLayers();
							},
							failure: function(result) {
								console.log(result);
								throw new Error(result);
							}
						});
						} 
					});
				});

			});



			function GoSpatialApi(apikey, server) {

				this.apikey = apikey;
				this.server = server || "";

				this.getCustomer = function() {
					var self = this;
					var data;
					this.GET("/api/v1/customer" + "?apikey=" + self.apikey, function(error, result){
						if (error) {
							throw error;
						} else {
							data = result;
						}
					});
					return data;
				}

				this.getLayer = function(datasource, callback) {
					var self = this;
					this.GET("/api/v1/layer/" + datasource + "?apikey=" + self.apikey, function(error, result){
						callback(error, result);
					});
				}

				this.submitFeature = function(datasource, feature, callback) {
					var self = this;
					this.POST(
						'/api/v1/layer/' + datasource + '/feature?apikey=' + self.apikey,
						feature,
						function(error, result) {
							callback(error, result);
						}
					)
				}

				this.GET = function(route, callback) {
					var self = this;
					$.ajax({
						crossDomain: true,
						type: "GET",
						async: false,
						url: route,
						dataType: 'JSON',
						success: function (data) {
							return callback(null, data);
						},
						error: function(xhr,errmsg,err) {
							console.log(xhr.status,xhr.responseText,errmsg,err);
							result = null;
							var message = "status: " + xhr.status + "<br>";
							message += "responseText: " + xhr.responseText + "<br>";
							message += "errmsg: " + errmsg + "<br>";
							message += "Error:" + err;
							return callback(new Error(message));
						}
					});
				}

				this.POST = function(route, data, callback) {
					var self = this;
					$.ajax({
						crossDomain: true,
						type: "POST",
						async: false,
						data: data,
						url: route,
						dataType: 'JSON',
						success: function (data) {
							callback(null, data);
						},
						error: function(xhr,errmsg,err) {
							console.log(xhr.status,xhr.responseText,errmsg,err);
							result = null;
							var message = "status: " + xhr.status + "<br>";
							message += "responseText: " + xhr.responseText + "<br>";
							message += "errmsg: " + errmsg + "<br>";
							message += "Error:" + err;
							callback(new Error(message));
						}
					});
				}
			}


			var GoSpatial = new GoSpatialApi({{.Apikey}});
			var customer = GoSpatial.getCustomer();

			var datasources = customer.datasources;
			if (datasources) {
				for (var i=0; i < datasources.length; i++) {
					var elem = $("<tr><td>" + i + "</td><td><button class='btn btn-sm btn-danger deleteLayer' ds_id=" + datasources[i] + "><i class='fa fa-trash layer'></i></button></li></td><td>" + datasources[i] + "</td></tr>");
					elem.id = datasources[i];
					console.log(datasources[i]);
					$("#layers_list").append(elem);
				}
			}
			var tilelayers = customer.tilelayers;
			if (tilelayers) {
				for (var i=0; i < tilelayers.length; i++) {
					var elem = $("<tr><td>" + i + "</td><td>" + tilelayers[i].name + "</td><td>" + tilelayers[i].url + "</td></tr>");
					elem.id = tilelayers[i];
					console.log(tilelayers[i]);
					$("#tilelayers_list").append(elem);
				}
			}




			function refreshDatasources() {
				var customer = GoSpatial.getCustomer();
				var datasources = customer.datasources;
				if (datasources) {
					for (var i=0; i < datasources.length; i++) {
						var elem = $("<tr><td>" + i + "</td><td><button class='btn btn-sm btn-danger deleteLayer' ds_id=" + datasources[i] + "><i class='fa fa-trash layer'></i></button></li></td><td>" + datasources[i] + "</td></tr>");
						elem.id = datasources[i];
						console.log(datasources[i]);
						$("#layers_list").append(elem);
					}
				}
				// gui: event listener
				$("button.deleteLayer").click(function(){
					var datasource_id = $(this).attr("ds_id");
					swal({
						title: "Delete layer",
						text: "Are you sure you want to delete " + datasource_id,
						type: "warning",	 
						showCancelButton: true,	 
						confirmButtonColor: "#DD6B55",	 
						confirmButtonText: "Yes, delete it!",	 
						cancelButtonText: "No, cancel pls!",	 
						closeOnConfirm: false,	 
						closeOnCancel: false,
						showLoaderOnConfirm: true
					},
					function(isConfirm){
						if (isConfirm) {
						$.ajax({
							url: '/api/v1/layer/'+ datasource_id +'?apikey={{.Apikey}}',
							type: 'DELETE',
							success: function(result) {
								swal("Deleted!", result, "success");
								$("#layers_list").html("");
								refreshDatasources();
							},
							failure: function(result) {
								console.log(result);
								throw new Error(result);
							}
						});
						} 
						else {
							swal("Cancelled", "Your data is safe :)", "error");
						}
					});
				});
			}

			function refreshTileLayers() {
				var customer = GoSpatial.getCustomer();
				var tilelayers = customer.tilelayers;
				if (tilelayers) {
					for (var i=0; i < tilelayers.length; i++) {
						var elem = $("<tr><td>" + i + "</td><td>" + tilelayers[i].name + "</td><td>" + tilelayers[i].url + "</td></tr>");
						elem.id = tilelayers[i];
						console.log(tilelayers[i]);
						$("#tilelayers_list").append(elem);
					}
				}
			}



		</script>

	</body>
</html>