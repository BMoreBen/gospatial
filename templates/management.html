<!DOCTYPE html>
<html>
	<head>
		<meta charset=utf-8 />
		<title>GoSpatial Gatekeeper</title>
		<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
	
		<!-- JQuery -->
		<script src="/jquery/jquery-1.11.0.js" ></script>

		<!-- Bootstrap -->
		<script src="/bootstrap/bootstrap.js"></script>
		<link href="/bootstrap/bootstrap.min.css" rel="stylesheet">
		<link href="/bootstrap/2-col-portfolio.css" rel="stylesheet">

		<!-- Font Awesome CSS -->
		<link rel="stylesheet" href="/font-awesome-4.3.0/css/font-awesome.min.css">

		<!-- Sweet Alert -->
		<script src="/sweetalert/sweetalert.min.js"></script>
		<link rel="stylesheet" type="text/css" href="/sweetalert/sweetalert.css">

	</head>
	<body>
		<!-- Navigation -->
		<nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
			<div class="container">
				<!-- Brand and toggle get grouped for better mobile display -->
				<div class="navbar-header">
					<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
						<span class="sr-only">Toggle navigation</span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
					</button>
					<a class="navbar-brand" href="../management?apikey={{.Apikey}}">
						 GoSpatial
					</a>
				</div>
				<!-- Collect the nav links, forms, and other content for toggling -->
				<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
					<ul class="nav navbar-nav">
						<li>
							<a href="../management?apikey={{.Apikey}}"><i class="fa fa-users"></i> Management</a>
						</li>
						<li>
							<a href="../map?apikey={{.Apikey}}"><i class="fa fa-compass"></i> Map</a>
						</li> 
						<li>
							<a href="http://sjsafranek.github.io/gospatial/"><i class="fa fa-question-circle"></i> Help</a>
						</li>
					</ul>
				</div>
				<!-- /.navbar-collapse -->
			</div>
			<!-- /.container -->
		</nav>

		<!-- Page Content -->
		<div class="container">
			<!-- Page Header -->
			<div class="row">
				<div class="col-lg-12">
					<h2 class="page-header">Management <small>Manage layers and basemaps</small></h2>
				</div>
			</div> 
			<!-- /. Page Header -->

			<div class="row clearfix" id="content-row">
				<div class="col-xs-12 column">
				<div class="row clearfix" id="content-row">
					<div class="col-xs-12 column">
					<h3>Layer Management</h3>
					</div>
				</div>
				<div class="well" id="volume-parameters-well">
					<div class="row clearfix" id="volume-fees-row">
					<div class="col-md-6 column" id="volume-fees-chart">
						<div class="panel panel-primary" id="volume-fees-panel">
						<div class="panel-heading">
							<h3 class="panel-title">New Layer</h3>
						</div>
						<div class="panel-body">
							<form action="../api/v1/layer?apikey={{.Apikey}}" enctype="multipart/form-data" method="post">
								<div class="form-group">
									<!-- <label for="name">Name:</label> -->
									<!-- <input type="text" name="name" class="form-control" id="name"> -->
									<input type="hidden" name="group" value={{.Apikey}}>
								</div>
								<div class="form-group">
								 <button type="submit" class="btn btn-default">Create new layer</button>
								 </div>
							</form>
						</div>
						</div>
					</div>
					<div class="col-md-6 column">
						<div class="panel panel-primary" id="volume-fees-summary-panel">
						<div class="panel-heading">
							<h3 class="panel-title">Current layers</h3>
						</div>
						<div class="panel-body">
							<p>
								<strong>
								Layers:
								</strong> 
								<ul id="layers_list">
								</ul>
							</p>
						</div>
						</div>
					</div>
					</div>
				</div>


				</div>
			</div>



    <div class="row clearfix" id="content-row">
      <div class="col-xs-12 column">
        <h3>TileLayer Management</h3>
      </div>
    </div>
    <div class="well" id="volume-parameters-well">
      <div class="row clearfix" id="volume-fees-row">
        <div class="col-md-6 column" id="volume-fees-chart">
          <div class="panel panel-primary" id="volume-fees-panel">
            <div class="panel-heading">
              <h3 class="panel-title">New TileLayer</h3>
            </div>
            <div class="panel-body">
              <form action="../api/v1/tilelayer?apikey={{.Apikey}}" enctype="multipart/form-data" method="post">
                <div class="form-group">
                    <label for="name">Name:</label>
                    <input type="text" name="tilelayer_name" class="form-control" id="name">
                    <label for="name">Url:</label>
                    <input type="text" name="tilelayer_url" class="form-control" id="url">
                  </div>
                <div class="form-group">
                  <button type="submit" class="btn btn-default">Create TileLayer</button>
                </div>
              </form>
            </div>
          </div>
        </div>
        <div class="col-md-6 column">
          <div class="panel panel-primary" id="volume-fees-summary-panel">
            <div class="panel-heading">
              <h3 class="panel-title">Current TileLayers</h3>
            </div>
            <div class="panel-body">
                <p>
                  <strong>
                    TileLayers:
                  </strong> 
                    <ul id="tilelayers_list">
						<!-- <li> name : url <i class="fa fa-trash"></i></li> -->
                    </ul>
                </p>
            </div>
          </div>
        </div>
      </div>
    </div>







		</div>
		<!-- /. Page Content -->













		<script>

			$(document).ready(function(){
			$(".fa.fa-trash.layer").click(function(){
				var datasource_id = $(this).closest("li").attr("id");
				swal({
					title: "Delete layer",
					text: "Are you sure you want to delete " + datasource_id,
					type: "warning",	 
					showCancelButton: true,	 
					confirmButtonColor: "#DD6B55",	 
					confirmButtonText: "Yes, delete it!",	 
					cancelButtonText: "No, cancel pls!",	 
					closeOnConfirm: false,	 
					closeOnCancel: true,
					showLoaderOnConfirm: true
				},
				function(isConfirm){
					if (isConfirm) {
					$.ajax({
						url: '/api/v1/layer/'+ datasource_id +'?apikey={{.Apikey}}',
						type: 'DELETE',
						success: function(result) {
						swal("Deleted!", result, "success");
						location.reload();
						},
						failure: function(result) { console.log(result); }
					});
					} 
					else {
					swal("Cancelled", "Your data is safe :)", "error");
					location.reload();
					}
				});
			})
			.css('cursor', 'pointer');
			});



			function GoSpatialApi(apikey, server) {

				this.apikey = apikey;
				this.server = server || "";

				this.getCustomer = function() {
					var self = this;
					var data;
					this.GET("/api/v1/customer" + "?apikey=" + self.apikey, function(error, result){
						if (error) {
							throw error;
						} else {
							data = result;
						}
					});
					return data;
				}

				this.getLayer = function(datasource, callback) {
					var self = this;
					this.GET("/api/v1/layer/" + datasource + "?apikey=" + self.apikey, function(error, result){
						callback(error, result);
					});
				}

				this.submitFeature = function(datasource, feature, callback) {
					var self = this;
					this.POST(
						'/api/v1/layer/' + datasource + '/feature?apikey=' + self.apikey,
						feature,
						function(error, result) {
							callback(error, result);
						}
					)
				}

				this.GET = function(route, callback) {
					var self = this;
					$.ajax({
						crossDomain: true,
						type: "GET",
						async: false,
						url: route,
						dataType: 'JSON',
						success: function (data) {
							return callback(null, data);
						},
						error: function(xhr,errmsg,err) {
							console.log(xhr.status,xhr.responseText,errmsg,err);
							result = null;
							var message = "status: " + xhr.status + "<br>";
							message += "responseText: " + xhr.responseText + "<br>";
							message += "errmsg: " + errmsg + "<br>";
							message += "Error:" + err;
							return callback(new Error(message));
						}
					});
				}

				this.POST = function(route, data, callback) {
					var self = this;
					$.ajax({
						crossDomain: true,
						type: "POST",
						async: false,
						data: data,
						url: route,
						dataType: 'JSON',
						success: function (data) {
							callback(null, data);
						},
						error: function(xhr,errmsg,err) {
							console.log(xhr.status,xhr.responseText,errmsg,err);
							result = null;
							var message = "status: " + xhr.status + "<br>";
							message += "responseText: " + xhr.responseText + "<br>";
							message += "errmsg: " + errmsg + "<br>";
							message += "Error:" + err;
							callback(new Error(message));
						}
					});
				}
			}


			var GoSpatial = new GoSpatialApi({{.Apikey}});
			var customer = GoSpatial.getCustomer();

			var datasources = customer.datasources;
			for (var i=0; i < datasources.length; i++) {
				var elem = $("<li id='" + datasources[i] + "'>" + datasources[i] + " <i class='fa fa-trash layer'></i></li>");
				elem.id = datasources[i];
				console.log(datasources[i]);
				$("#layers_list").append(elem);
			}

			var tilelayers = customer.tilelayers;
			for (var i=0; i < tilelayers.length; i++) {
				var elem = $("<li>" + tilelayers[i].name + ": " + tilelayers[i].url + "</li>");
				elem.id = tilelayers[i];
				console.log(tilelayers[i]);
				$("#tilelayers_list").append(elem);
			}


		</script>

	</body>
</html>