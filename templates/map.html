<!DOCTYPE html>
<html>
    <head>
        <meta charset=utf-8 />
        <title>Go Geospatial</title>
        <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

        <!--  Leaflet.draw-master  -->
        <script src="/Leaflet.draw-master/libs/leaflet-src.js"></script>
        <link rel="stylesheet" href="/Leaflet.draw-master/libs/leaflet.css" />

        <script src="/Leaflet.draw-master/src/Leaflet.draw.js"></script>
        <link rel="stylesheet" href="/Leaflet.draw-master/dist/leaflet.draw.css" />

        <script src="/Leaflet.draw-master/src/Toolbar.js"></script>
        <script src="/Leaflet.draw-master/src/Tooltip.js"></script>

        <script src="/Leaflet.draw-master/src/ext/GeometryUtil.js"></script>
        <script src="/Leaflet.draw-master/src/ext/LatLngUtil.js"></script>
        <script src="/Leaflet.draw-master/src/ext/LineUtil.Intersect.js"></script>
        <script src="/Leaflet.draw-master/src/ext/Polygon.Intersect.js"></script>
        <script src="/Leaflet.draw-master/src/ext/Polyline.Intersect.js"></script>

        <script src="/Leaflet.draw-master/src/draw/DrawToolbar.js"></script>
        <script src="/Leaflet.draw-master/src/draw/handler/Draw.Feature.js"></script>
        <script src="/Leaflet.draw-master/src/draw/handler/Draw.SimpleShape.js"></script>
        <script src="/Leaflet.draw-master/src/draw/handler/Draw.Polyline.js"></script>
        <script src="/Leaflet.draw-master/src/draw/handler/Draw.Circle.js"></script>
        <script src="/Leaflet.draw-master/src/draw/handler/Draw.Marker.js"></script>
        <script src="/Leaflet.draw-master/src/draw/handler/Draw.Polygon.js"></script>
        <script src="/Leaflet.draw-master/src/draw/handler/Draw.Rectangle.js"></script>

        <script src="/Leaflet.draw-master/src/edit/EditToolbar.js"></script>
        <script src="/Leaflet.draw-master/src/edit/handler/EditToolbar.Edit.js"></script>
        <script src="/Leaflet.draw-master/src/edit/handler/EditToolbar.Delete.js"></script>

        <script src="/Leaflet.draw-master/src/Control.Draw.js"></script>

        <script src="/Leaflet.draw-master/src/edit/handler/Edit.Poly.js"></script>
        <script src="/Leaflet.draw-master/src/edit/handler/Edit.SimpleShape.js"></script>
        <script src="/Leaflet.draw-master/src/edit/handler/Edit.Circle.js"></script>
        <script src="/Leaflet.draw-master/src/edit/handler/Edit.Rectangle.js"></script>
        <script src="/Leaflet.draw-master/src/edit/handler/Edit.Marker.js"></script>

        <!--  Leaflet.measure  -->
        <script src="/leaflet.measure/leaflet.measure.js"></script>
        <link rel="stylesheet" href="/leaflet.measure/leaflet.measure.css" />

        <!-- Leaflet.geosearch -->
        <script src="/L.GeoSearch-master/src/js/l.control.geosearch.js"></script>
        <script src="/L.GeoSearch-master/src/js/l.geosearch.provider.openstreetmap.js"></script>
        <link rel="stylesheet" href="/L.GeoSearch-master/src/css/l.geosearch.css" />

        <!-- Leaflet.buildigns -->
        <script src="/osmbuildings/dist/OSMBuildings-Leaflet.js"></script>

        <!-- D3 and JQuery -->
        <script src="/js/jquery-1.11.0.js"></script>  <!-- | JQUERY -->
        <!-- <script src="/js/jquery-ui-1.11.4.js"></script> -->  <!-- JQUERY UI -->
        <script src = "/js/d3.js"></script>

        <!-- LOCATE CONTROL -->
        <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
        <link rel="stylesheet" href="/L.Control.Locate.min.css" />
        <script src="/L.Control.Locate.min.js" ></script>

        <!-- HEAT MAP -->
    <!--
        <script src='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-heat/v0.1.0/leaflet-heat.js'></script>
    -->
        <!-- <script src='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-heat/v0.1.3/leaflet-heat.js'></script> -->

        <!-- Font Awesome CSS -->
        <link rel="stylesheet" href="/font-awesome-4.3.0/css/font-awesome.min.css">

        <!-- MapClient -->
        <script src='/writefeatures.js'></script>
        <link href="/css/mapClient.css" rel="stylesheet">

        <!-- Utils -->
        <script src='/find-utils.js'></script>

       <!-- Leaflet Libraries to Map -->
       <script src='/add_leaflet_libraries.js'></script>

    </head>
    <body>

        <div id='map'> </div>

        <script>

            var map = initMap("map", [{{.Datasource}}]);
            add_leaflet_libraries(map);

            // Draw Features
            var drawnItems = L.featureGroup().addTo(map);
            map.addControl(new L.Control.Draw({
                draw: { circle: false },
                edit: { featureGroup: drawnItems }
            }));

            var feature_types = {
                "marker": "Point",
                "polygon": "Polygon",
                "rectangle": "Polygon",
                "polyline": "LineString"
            };

            function sendFeature(id) {
                var results;
                var feature = drawnItems._layers[id];
                var payload = {
                    "geometry": {
                        "type": feature_types[feature.layerType],
                        "coordinates": []
                    },
                    "properties": getProperties()
                }
                if (payload.geometry.type == "Point") {
                    payload.geometry.coordinates.push(feature._latlng.lng);
                    payload.geometry.coordinates.push(feature._latlng.lat);
                } else if (payload.geometry.type == "LineString") {
                    for (var i = 0; i < feature._latlngs.length; i++) {
                        payload.geometry.coordinates.push([feature._latlngs[i].lng,feature._latlngs[i].lat])
                    }
                } else if (payload.geometry.type == "Polygon") {
                    payload.geometry.coordinates.push([]);
                    for (var i = 0; i < feature._latlngs.length; i++) {
                        payload.geometry.coordinates[0].push([feature._latlngs[i].lng,feature._latlngs[i].lat])
                    }
                } else {
                    alert("Unknown feature type!")
                    return results
                }
                results = Utils.postRequest(
                    '/api/v1/layer/' + $('#layers').val() + '/feature',
                    JSON.stringify(payload)
                );
                map.getLayer($('#layers').val());
                map.removeLayer(drawnItems._layers[id]);
                $("#properties .attr").val("");
                return results;
            }

            var popup = L.popup();
            function onMapClick(e) {
                if (e.target.editing._enabled) {  console.log('editing enabled')  }
                else {
                    popup
                        .setLatLng(e.latlng)
                        .setContent("<input type='button' value='Submit Feature' onClick='sendFeature(" + e.target._leaflet_id + ")'/>")
                        .openOn(map);
                }
            }

            map.on('draw:created', function(event) {
                var layer = event.layer;
                layer.on('click', onMapClick);
                layer.options.color='blue';
                layer.layerType = event.layerType;
                drawnItems.addLayer(layer);
            });


            var featureProperties = L.control({position: 'bottomleft'});
            featureProperties.onAdd = function (map) {
                var div = L.DomUtil.create('div', 'info legend properties_form');
                div.innerHTML = "<h4>Feature Properties</h4>";
                div.innerHTML += "<a href='#' id='add_property'><i class='fa fa-plus' style='padding-left:5px; margin-right:0px;'></i>Add Field</a><br>";
                div.innerHTML += "<div id='properties'>";
                div.innerHTML += "</div>";
                return div;
            };
            featureProperties.addTo(map);

            $("#add_property").on("click", function() {
                $("#properties").append("<input type='text' class='field' placeholder='field'><input type='text' class='attr' placeholder='attribute'><br>");
            });

            function getProperties() {
                var prop = {};
                var fields = $("#properties .field");
                var attrs = $("#properties .attr");
                for (var _i=0; _i < fields.length; _i++) {
                    prop[fields[_i].value] = attrs[_i].value;
                }
                return prop;
            }

        </script>

    </body>
</html>
